<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <!-- 
  由于promise具备链式调用的特点（即then方法默认返回 一个新的promise实例）
  当  需要具备串联发请求的动作时， 请求具备事务性，
  则 promise的链式调用特性就不太友好，此时需要手动切断promise， 
  操作原理：返回一个pending状态的promise即可
  return new Promise(()=>{})
 -->
</body>
<script>
  /*
  中断promise链：
					(1)当使用promise的then链式调用时, 在中间中断, 不再调用后面的回调函数。
					(2)办法: 在失败的回调函数中返回一个pendding状态的promise实例。
  */
  function sendAjax(url, data) {
    return new Promise((resolve, reject) => {
      let xhr = new XMLHttpRequest();
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) resolve(xhr.response);
          else reject('请求出错了');

        }
      };
      //url需要拼接成UrlEncode【也叫？传参】
      let str = '';
      for (let key in data) {
        str += `${key}=${data[key]}&`;
      }
      str = str.slice(0, -1);
      xhr.open('GET', url + '?' + str);
      xhr.responseType = 'json'
      xhr.send();
    });
  }

  sendAjax('https://api.apiopen.top/api/getHaoKanVideo啊哈', {
    page: 2,
    size: 10
  })
  .then(
    value=>{
      console.log('第1次请求成功的结果：', value);
      return sendAjax('https://api.apiopen.top/api/getHaoKanVideo', {
        page: 2,
        size: 10
      })
    },
    reason=>{
      console.log('第1次请求失败了，失败的原因是：', reason);
      //中断then方法返回的那个promise
      return new Promise(()=>{});
    }
  ).then(
    value=>{
      console.log('第2次请求成功的结果：', value);
      return sendAjax('https://api.apiopen.top/api/getHaoKanVideo', {
        page: 2,
        size: 10
      })
    },
    reason=>{
      console.log('第2次请求失败了，失败的原因是：', reason);
      //中断then方法返回的那个promise
      return new Promise(()=>{});
    }
  ).then(
    value=>{
      console.log('第3次请求成功的结果：', value);
      return sendAjax('https://api.apiopen.top/api/getHaoKanVideo?', {
        page: 2,
        size: 10
      })
    },
    reason=>{
      console.log('第3次请求失败了，失败的原因是：', reason);
      //中断then方法返回的那个promise
      return new Promise(()=>{});
    }
  )
</script>

</html>